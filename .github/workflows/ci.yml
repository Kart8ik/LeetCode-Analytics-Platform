name: CI Pipeline

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch: {}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Install dependencies
        run: |
          npm ci

  test:
    name: Test (with coverage)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage

  coverage-check:
    name: Coverage check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: List coverage files for debugging
        run: |
          echo "Coverage folder contents:" || true
          ls -la coverage || true
          echo "Recursive tree:" || true
          ls -R coverage || true

      - name: Check coverage threshold
        run: node ./scripts/check-coverage.cjs 80

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: coverage-check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint and produce JSON report
        run: npm run lint:ci

      - name: Upload lint report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: lint-report.json

  security:
    name: Security audit
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.19.0

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > security-report.json || true

      - name: Fail on high/critical vulnerabilities
        run: node ./scripts/check-security.cjs

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  deploy:
    name: Package deployment artifact
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install zip (if needed)
        run: sudo apt-get update && sudo apt-get install -y zip || true

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage

      - name: Download lint report
        uses: actions/download-artifact@v4
        with:
          name: lint-report
          path: .

      - name: Download security report
        uses: actions/download-artifact@v4
        with:
          name: security-report
          path: .

      - name: Create deployment package
        run: |
          mkdir -p deployment
          cp -r src deployment/ || true
          cp -r coverage deployment/coverage || true
          cp lint-report.json deployment/ || true
          cp security-report.json deployment/ || true
          cp README.md deployment/ || true
          cd deployment
          zip -r ../deployment-package-${{ github.sha }}.zip . || true

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package-*.zip
